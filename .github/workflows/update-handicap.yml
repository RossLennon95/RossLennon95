
name: Update Handicap Text (Puppeteer)

on:
  schedule:
    - cron: '0 0 * * *'   # Runs daily at midnight UTC
  workflow_dispatch:       # Allows manual trigger

permissions:
  contents: write

jobs:
  update-handicap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Scrape handicap using Puppeteer
        run: |
          node <<'EOF'
          const puppeteer = require('puppeteer');

          (async () => {
            const username = process.env.HDID_USERNAME;
            const password = process.env.HDID_PASSWORD;
            const profileUrl = `https://www.howdidido.com/profile/${username}`;

            const browser = await puppeteer.launch({ headless: true });
            const page = await browser.newPage();

            // Go to login page
            await page.goto('https://www.howdidido.com/Login', { waitUntil: 'networkidle2' });

            // Fill login form
            await page.type('input[name="username"]', username);
            await page.type('input[name="password"]', password);
            await page.click('button[type="submit"]');

            // Wait for navigation after login
            await page.waitForNavigation({ waitUntil: 'networkidle2' });

            // Go to profile page
            await page.goto(profileUrl, { waitUntil: 'networkidle2' });

            // Extract handicap text
            let handicap = await page.evaluate(() => {
              const el = document.querySelector('.handicap-value, .handicap'); // Adjust selector if needed
              return el ? el.textContent.trim() : null;
            });

            if (!handicap) handicap = 'N/A';

            console.log(`Scraped handicap: ${handicap}`);

            // Write to env file for next steps
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_ENV, `HANDICAP=${handicap}\n`);

            await browser.close();
          })();
          EOF
        env:
          HDID_USERNAME: ${{ secrets.HDID_USERNAME }}
          HDID_PASSWORD: ${{ secrets.HDID_PASSWORD }}

      - name: Get current date
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Update README with text and timestamp
        run: |
          if [ "${HANDICAP}" = "N/A" ]; then
            DISPLAY_TEXT="Current Handicap: Not Available (Scrape failed)"
          else
            DISPLAY_TEXT="Current Handicap: ${HANDICAP}"
          fi

          if grep -q 'Current Handicap:' README.md; then
            perl -0777 -pe "s|Current Handicap: [^\\n]*|${DISPLAY_TEXT}|g" -i README.md
          else
            echo -e "\n## My Golf Handicap\n${DISPLAY_TEXT}\n" >> README.md
          fi

          if grep -q 'Last updated:' README.md; then
            perl -0777 -pe "s|Last updated: [^\\n]*|Last updated: ${DATE}|g" -i README.md
          else
            echo -e "Last updated: ${DATE}\n" >> README.md
          fi

          echo "----- README preview -----"
          head -n 20 README.md

      - name: Commit and push if changed
        run: |
          if ! git diff --quiet -- README.md; then
            git add README.md
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update handicap (${HANDICAP}) and timestamp (${DATE})"
            git pull --rebase || true
            git push
          else
            echo "No changes detected."
          fi
