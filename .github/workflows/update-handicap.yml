name: Update Handicap Text (Puppeteer)

on:
  schedule:
    - cron: '0 0 * * *'   # Runs daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-handicap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install Chromium dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 libxkbcommon0 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libpango-1.0-0 \
            libasound2 libxshmfence1 libxext6 libx11-xcb1 libx11-6 libxss1 \
            fonts-liberation ca-certificates

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Scrape handicap using Puppeteer
        id: scrape
        run: |
          node <<'EOF'
          const fs = require('fs');
          const puppeteer = require('puppeteer');

          (async () => {
            const username = process.env.HDID_USERNAME;
            const password = process.env.HDID_PASSWORD;
            const profileUrl = `https://www.howdidido.com/profile/${username}`;
            let handicap = 'N/A';
            let htmlSnapshot = '';

            try {
              const browser = await puppeteer.launch({
                headless: true,
                args: ['--no-sandbox','--disable-setuid-sandbox']
              });
              const page = await browser.newPage();
              page.setDefaultTimeout(30000);

              // Go to login page
              await page.goto('https://www.howdidido.com/Login', { waitUntil: 'networkidle2' });

              // Fill login form using correct selectors
              await page.type('input[name="UserName"]', username);
              await page.type('input[name="Password"]', password);

              // Click submit
              await page.click('button[type="submit"]');

              // Wait for navigation after login
              await page.waitForNavigation({ waitUntil: 'networkidle2' });

              // Navigate to profile page
              await page.goto(profileUrl, { waitUntil: 'networkidle2' });

              // Capture HTML for debugging
              htmlSnapshot = await page.content();

              // Extract handicap from text
              const text = await page.evaluate(() => document.body.innerText);
              const match = text.match(/Handicap[:\s]+([0-9]+(?:\.[0-9]+)?)/i);
              if (match) {
                handicap = match[1].trim();
              }

              await browser.close();
            } catch (err) {
              console.error('Scrape error:', err.message);
            }

            fs.appendFileSync(process.env.GITHUB_ENV, `HANDICAP=${handicap}\n`);
            fs.writeFileSync('profile.html', htmlSnapshot || '');
          })();
          EOF
        env:
          HDID_USERNAME: ${{ secrets.HDID_USERNAME }}
          HDID_PASSWORD: ${{ secrets.HDID_PASSWORD }}

      - name: Upload profile HTML snapshot (debug)
        uses: actions/upload-artifact@v4
        with:
          name: howdidido-profile
          path: profile.html

      - name: Get current date and time
        run: echo "DATETIME=$(date +'%d-%m-%Y %H:%M:%S UTC')" >> $GITHUB_ENV

      - name: Update README with text and timestamp
        run: |
          if [ "${HANDICAP}" = "N/A" ]; then
            DISPLAY_TEXT="Current Handicap: Not Available (Scrape failed)"
          else
            DISPLAY_TEXT="Current Handicap: ${HANDICAP}"
          fi

          if grep -q 'Current Handicap:' README.md; then
            perl -0777 -pe "s|Current Handicap: [^\\n]*|${DISPLAY_TEXT}|g" -i README.md
          else
            echo -e "\n## My Golf Handicap\n${DISPLAY_TEXT}\n" >> README.md
          fi

          if grep -q 'Last updated:' README.md; then
            perl -0777 -pe "s|Last updated: [^\\n]*|Last updated: ${DATETIME}|g" -i README.md
          else
            echo -e "Last updated: ${DATETIME}\n" >> README.md
          fi

          echo "----- README preview -----"
          head -n 20 README.md

      - name: Commit and push if changed
        run: |
          if ! git diff --quiet -- README.md; then
            git add README.md
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update handicap (${HANDICAP}) and timestamp (${DATETIME})"
            git pull --rebase || true
            git push
          else
            echo "No changes detected."
          fi
