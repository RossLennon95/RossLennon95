
name: Update TryHackMe Badge

on:
  schedule:
    - cron: '0 0 * * *'   # Every day at 00:00 UTC
  workflow_dispatch:       # Allows manual trigger

# Allow the workflow to push using GITHUB_TOKEN
permissions:
  contents: write

jobs:
  update-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0           # full history so git diff works
          persist-credentials: true # keep GITHUB_TOKEN for push

      - name: Show repo state (before)
        run: |
          echo "Branch: $(git branch --show-current)"
          git status
          ls -la

      - name: Download badge
        run: |
          set -e
          curl -fsSL -o tryhackme_badge.png https://tryhackme-badges.s3.amazonaws.com/rossplennon.png
          file tryhackme_badge.png || true
          ls -lh tryhackme_badge.png

      - name: Commit and push if changed
        run: |
          # Check if the file has changed compared to HEAD
          if ! git diff --quiet -- tryhackme_badge.png; then
            git add tryhackme_badge.png
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update TryHackMe badge"
            git pull --rebase
            git push
            echo "Badge updated and pushed."
          else
            echo "No changes detected; skipping commit."
          fi

      - name: Show repo state (after)
        run: |
          git status
          ls -la
